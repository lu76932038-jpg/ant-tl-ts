# 询价解析 2.0 开发变更记录 (Development Change Log)

**日期**: 2026-01-18
**状态**: 已完成 (Backend & Frontend Implemented)

## 1. 数据库变更 (Database)

- **新增表**: `inquiry_tasks`
  - 用于存储用户的询价解析历史记录。
  - 核心字段: `id` (UUID), `user_id`, `file_name`, `file_path` (原始文件存储路径), `parsed_result` (JSON结果), `shared_with` (分享给谁)。
  - 对应模型文件: `server/src/models/InquiryTask.ts`

## 2. 后端开发 (Backend)

- **新增依赖**:
  - `xlsx`: 用于生成和解析 Excel 文件。
  - `mammoth`: 用于解析 Word (.docx) 文件。
- **新增接口 (`server/src/routes/inquiryRoutes.ts`)**:
  - `POST /api/inquiry/upload`: 接收文件上传，保存到 `server/uploads`，调用 AI 解析，并创建任务记录。
  - `GET /api/inquiry`: 获取当前用户及被分享的任务列表。
  - `GET /api/inquiry/:id`: 获取任务详情。
  - `GET /api/inquiry/:id/download/original`: 下载原始上传文件。
  - `GET /api/inquiry/:id/download/result`: 实时生成并下载解析后的 Excel 报表。
  - `PUT /api/inquiry/:id/share`: 分享任务给其他用户。
- **服务层**:
  - `server/src/services/inquiryService.ts`: 封装了文件读取（支持 Excel, Word, PDF, 图片）和调用 AI (`geminiService`) 的逻辑。
- **入口更新**:
  - `server/src/app.ts`: 注册了 `/api/inquiry` 路由。
  - `server/src/server.ts`: 启动时初始化 `inquiry_tasks` 数据库表。

## 3. 前端开发 (Frontend)

- **新增页面**:
  - `src/pages/InquiryHistory.tsx`: 历史任务看板。
    - 展示任务列表（文件名、大小、时间、状态）。
    - 提供“下载原始文件”、“下载解析结果”、“分享”功能。
- **现有页面改造**:
  - `src/pages/MainApp.tsx`:
    - 修改上传逻辑：不再仅在前端解析，而是调用 `POST /api/inquiry/upload` 上传至后端。
    - 新增入口：顶部栏增加“历史任务”按钮，跳转至 `/inquiry-history`。
- **通用组件/服务**:
  - `src/services/api.ts`: 封装了基于 `axios` 的请求服务（统一处理 Base URL 和 Token）。
- **路由配置**:
  - `src/App.tsx`: 注册了 `/inquiry-history` 路由。

## 4. 文件存储结构

- **服务器**: 上传文件存储于 `server/uploads` 目录。
- **安全**: 仅拥有者及被分享者有权下载文件。
